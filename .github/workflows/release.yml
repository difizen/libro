# https://github.com/sveltejs/kit/blob/32afba695088b946aefe96da75b36de9b0667fbe/.github/workflows/release.yml
name: 'Release'

on:
  push:
    branches: ['ximo_dev']

jobs:
  changesets:
    # prevents this action from running on forks
    if: github.repository == 'difizen/libro'

    name: Changesets
    uses: difizen/actions/.github/workflows/release-changesets.yml@main
    secrets:
      BOT_APP_ID: ${{ secrets.BOT_APP_ID }}
      BOT_PRIVATE_KEY: ${{ secrets.BOT_PRIVATE_KEY }}

    permissions:
      pull-requests: write
      contents: write

  ci:
    needs: [changesets]
    if: |
      needs.changesets.outputs.should-release == 'true'

    name: Prerelease CI
    uses: ./.github/workflows/ci.yml

    permissions:
      contents: read
      actions: read

    # 新增的 release-notes Job
  release-notes:
    name: Generate Release Notes
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: npm install

      - name: Generate GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.sha }} # 自动生成的 tag
          release_name: Release ${{ github.sha }} # 自动生成的 Release 名称
          body: |
            ## Changes
            $(npx changeset status --snapshot)  # 使用 changeset 文案生成 Release Notes
          draft: false # 直接发布而非草稿
